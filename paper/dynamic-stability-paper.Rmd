---
title: "Dynamic indicators of systemic change and resilience"
author: "Hao Ye"
date: "`r Sys.Date()`"
output:
  - bookdown::html_document2
  - bookdown::pdf_document2
vignette: >
  %\VignetteIndexEntry{Dynamic indicators of systemic change and resilience}
  %\VignetteEngine{knitr::rmarkdown_notangle}
  %\VignetteEncoding{UTF-8}
bibliography: my_lib.bib
---

```{r setup, include = FALSE}
LOCAL <- identical(Sys.getenv("LOCAL"), "true")
knitr::opts_chunk$set(purl = LOCAL, 
                      collapse = TRUE,
                      comment = "#>", 
                      fig.width = 6
)

library(portalDS)
```

# Abstract

Quantifying change in a high-dimensional complex systems is challenging. The observed changes in state can occur as a result of endogenous dynamics, external forcing, or their interactions in addition to being deterministic, stochastic, or deterministic responses to stochastic forcing.

Among the ecological literature, there is substantial focus on determining whether systems are "stable" and computing metrics of "stability". However, the complexity of possible system changes exceeds such binary or scalar quantifications. Here, we explore 


# Introduction

<!-- importance of whole system change -->

Ecosystems are changing, understanding the nature of changes and their causes is important for decision-making. In other words, how likely are the observations of specific changes under different conceptual models of how ecosystems work.

Unfortunately, ecosystems are complex, with not just multiple components, but interactions among those components that produce dynamics and patterns on multiple scales. Thus, even summarizing the high-dimensional state of an ecosystem is a challenging task.

<!-- motivation for taking a dynamical view -->

Using time series is a natural way to investigate this question. Multiple values through time are required for determining baselines, and examination of the changes over time contains inherent information about what are the plausible underlying mechanisms for generating those changes.

<!-- brief review of history (re: system stability and metrics) -->

Historically, ecosystem stability has been characterized based on the interaction matrix [@May_1973a; @Pimm_1984; @Novak_2016]. We briefly summarize this approach:

1. Let the abundances of the component species in a system be $n_i$, with $i$ taking on values from $1$ to $s$, the number of species.
2. Assume that the population dynamics for each species is a function of the other species: $\displaystyle \frac{\mathrm{d} n_i}{\mathrm{d} t} = F_i \left(n_1(t), n_2(t), ..., n_s(t) \right)$
3. Let the system be in the vicinity of an equilibrium. Then the population dynamics can be linearized around this equilibrium point: $\displaystyle \frac{\mathrm{d} n_i}{\mathrm{d} t} \approx \sum_j{a_{ij} n_j(t)}$, where $a_{ij}$ are the elements of the community matrix $\mathrm{A}$.
4. The asymptotic stability of the equilibrium point is determined by the signs of the real components of the eigenvalues of the community matrix. Stability occurs when $\textrm{Re}\left(\lambda_i\right) < 0$ for all $\lambda_i$.

This measure is static, and does not reflect 
nonstable
dynamic interactions
local bifurcation (critical slowing down)

<!-- narrow down to specific research topic (empirical measures of system change) -->
What to do? 

Empirical dynamic modeling provides a way to estimate interaction strengths as they change in time. 
Ushio et al. [-@Ushio_2018] introduced "dynamic stability" as an empirical measure of ecosystem stability. Dynamic stability is defined as the dominant eigenvalue of the time-varying interaction matrix, and is thus a time-varying, continuous analogue to the static, binary definition of stability in Pimm [-@Pimm_1984]. At each time point, dynamic stability is a continuous quantity (with values above 1 corresponding to stable states, and values below 1 corresponding to unstable states).

$$\textrm{dynamic stability}(t) = \left|\lambda_{\textrm{dom}}(t)\right|$$

<!-- details of what dynamic stability and related measures are -->




<!-- summary of questions and approaches -->

```{r portal block setup, include = FALSE}
block <- make_portal_block(filter_q = 0.5)
```


(ref:portal-time-series-caption) Abundance time series of `r NCOL(block)-1` species from control plots at Portal, AZ.

```{r portal-time-series, fig.cap = '(ref:portal-time-series-caption)', echo = FALSE}
plot_time_series(block, scale = NULL)
```



# Methods
We test our EDM-based community change metrics on abundance time series from the rodent community at Portal, AZ [@Ernest_2019]. 

## Data

Following [@Christensen_2018], we compute the site-wide abundance on the 8 control plots for the Portal data up through April 2015. Although data collection at this site is ongoing, treatments were changed on half of the plots in 2015. Extending the time series past this point would reduce the number of plots with continuous observations of the control condition. More importantly, using a different set of plots would complicate comparisons with the dataset used by @Christensen_2018. Rodent abundances are aggregated across plots and scaled to 8 plots of sampling; in some cases, only some of the plots at the site were sampled, e.g. due to weather.

Because EDM methods rely on extracting signal from the time series directly, it is important that the data contain enough variation for meaningful analysis. Thus, we pre-filter the species to those where at least half of the time points yielded one observation (i.e. non-zero observed abundance). This reduces the number of species from 21 to 7 (see Figure \@ref(fig:portal-time-series)). Finally, to address missing censuses, we apply linear interpolation to construct time series with regular time intervals using the `na.interp()` function from the `forecast` R package [@Hyndman_2019].

## Dynamic Stability Analysis

The general procedure for the analysis follows the outline described in [@Ushio_2018]:

1. For each individual time series, $n_i, i \in \{1 \dots s\}$, apply simplex projection [@Sugihara_1990] to identify the optimal embedding dimension, $E_i$  Here, we test values of $E_i$ from $1$ to $16$, choosing the value that minimizes mean absolute error of one-step ahead forecasts.

2. Construct the pairwise interaction network, using convergent cross mapping (CCM) [@Sugihara_2012]. For each pair of $i, j \in \{1 \dots s\}, i \ne j$, we test whether there is a causal effect of $n_j$ on $n_i$, $n_j \rightarrow n_i$, by cross mapping from $n_i$ to $n_j$, $n_i \xrightarrow{\text{xmap}} n_j$. For the CCM analysis of $n_i \xrightarrow{\text{xmap}} n_j$, the embedding dimension of $n_i$ identified in step 1 is used.  
  Parameters for CCM are as follows:  
    * library sizes: `r seq(10, 100, by = 10)`
    * number of samples at each library size: `r 100`
    * points within each sample are sampled randomly, and with replacement
    * links are significant if $\rho_{L=100} - \rho_{L=10} > 0.1$ (i.e. the increase in cross map $\rho$ is greater than $0.1$) and $\rho_{L=100}$ exceeds the `0.975` quantile of a null distribution of $\rho_{L=100}$ computed using surrogate time series of $n_i$
    * for each $n_i$, $200$ surrogate time series are generated (see \@ref(ccm-surrogates) for details)

3. For each time series $n_i$, fit a time series model with dimensionality of at least $E_i$ using the S-map method [@Sugihara_1994]. The predictors for each $n_i$ include the causal influences identified in step 2.  
  Let $V_i = \{k, n_k \rightarrow n_i\}$ identify the causal influences of $n_i$. In the typical univariate S-map model for $n_i$, the state vector is defined as:
  $$\mathbf{x}_i(t) = \langle n_i(t), n_i(t-1), \dots, n_i(t-(E_i-1)) \rangle$$
  In the multivariate S-map model for $n_i$, each causal influence of $n_i$ is substituted for a lag of $n_i$, starting with the oldest. The resulting state vector is defined as:  
  $$\mathbf{x}_i(t) = \langle n_i(t), \left\{n_k(t), k \in V_i\right\}, n_i(t-1), \dots, n_i(t-(E_i-\left|V_i\right|-1)\rangle$$  
  If $\left|V_i\right| \ge E_i$, then the state vector includes no lags, and consists instead of $n_i(t)$ and each $n_k(t)$.  
  The multivariate state vector, $\mathbf{x}_i(t)$, is then used in the S-map model:  
  \begin{equation}
  \hat{n}_i(t+1) = \mathbf{b}_i(t) \cdot \mathbf{x}_i(t) + c^0_i(t)
  (\#eq:species-smap-model)
  \end{equation}  
  The coefficients $\mathbf{b}_i(t)$ are fitted with nonlinear tuning parameter, $\theta$. $\theta$ is selected as the value which minimizes the mean absolute error of one-step ahead forecasts, from among: {`r c( seq(0, 1, by = 0.1), seq(1.5, 10, by = 0.5))`}
  
4. The individual S-map models, \@ref(eq:species-smap-model), can be combined to represent the dynamics of the system in matrix form:  
  \begin{equation}
  \mathbf{N}(t+1) = \mathbf{J}_0(t) \mathbf{N}(t) + \mathbf{J}_1(t) \mathbf{N}(t-1) + \dots + \mathbf{J}_d(t) \mathbf{N}(t-d) + \mathbf{C}^0(t)
  (\#eq:system-smap-model)
  \end{equation}  
  where $d$ represents the largest lag from any individual S-map model, $d = \mathrm{max} \{0, E_1 - \left|V_1\right| - 1, E_2 - \left|V_2\right| - 1, \dots, E_s - \left|V_s\right| - 1\}$. The matrix variables are defined as: $\mathbf{N}(t) = \begin{pmatrix} n_1(t) \\ n_2(t) \\ \vdots \\ n_s(t) \end{pmatrix}$, $\mathbf{C}^0(t) = \begin{pmatrix} c_1^0(t) \\ c_2^0(t) \\ \vdots \\ c_s^0(t) \end{pmatrix}$ and the $\mathbf{J}_\tau(t)$ contain the elements of the S-map coefficients in $\mathbf{b}_i(t)$ distributed accordingly:
    * $J_{0, i, j} =  b_{i, n_j}$ when $i = j$ or $n_j \rightarrow n_i$ and so $b_{i, n_j}$ is estimated in \@ref(eq:species-smap-model)
    * $J_{\tau, i, i} = b_{i, n_i(t-\tau)}$ when $n_i(t-\tau)$ is a component of $\mathbf{x}_i(t)$ and so $b_{i, n_i(t-\tau)}$ is estimated in \@ref(eq:species-smap-model)
    * $J_{\tau, i, j} = 0$, otherwise.  
  \@ref(eq:system-smap-model) can then be re-written as:
  \begin{equation}
  \mathbf{W}(t+1) = \mathbf{J}(t) \mathbf{W}(t) + \mathbf{B}(t)
  (\#eq:system-matrix-model)
  \end{equation}  
  with $\mathbf{W}(t) = \begin{pmatrix} \mathbf{N}(t) \\ \mathbf{N}(t-1) \\ \mathbf{N}(t-2) \\ \vdots \\ \mathbf{N}(t-d) \end{pmatrix}$ and $\mathbf{B}(t) = \begin{pmatrix} \mathbf{C}^0(t) \\ \mathbf{0} \\ \mathbf{0} \\ \vdots \\ \mathbf{0} \end{pmatrix}$ and $\mathbf{J}(t) = \begin{pmatrix} \mathbf{J}_0(t) & \mathbf{J}_1(t) & \dots & \dots & \mathbf{J}_d(t) \\
  I & \mathbf{0} & \dots & \mathbf{0} & \mathbf{0} \\
  \mathbf{0} & I & \dots & \mathbf{0} & \mathbf{0} \\
  \vdots & \vdots & \ddots & \vdots & \vdots\\
  \mathbf{0} & \mathbf{0} & \dots & I & \mathbf{0} \end{pmatrix}$.  
  Here, $I$ is the identity matrix of size $s$, and $\mathbf{0}$ is the zero matrix or vector, accordingly.

5. According to [@Deyle_2016], the coefficients of the multivariate S-map model, \@ref(eq:species-smap-model), can be interpreted as the time-varying interactions between individual time series. Via [@Ushio_2018], the matrix $\mathbf{J}(t)$ is then the time-varying interaction matrix, whose properties characterize the state-dependent dynamics of the system (here, estimated at each time step). Thus, metrics computed on $\mathbf{J}(t)$ are quantitative summaries of how the system is changing.

## Metrics for community change{#metrics}

We compute the following metrics on $\mathbf{J}(t)$:

  * "dynamic stability" is the magnitude of the dominant eigenvalue of $\mathbf{J}(t)$, as in [@Ushio_2018]:  
  $$\textrm{dynamic stability}(t) = \left|\lambda_{\textrm{dom}}(t)\right|$$
  * "local convergence" is the largest singular value in the singular value decomposition of $\mathbf{J}(t)$:
  $$\textrm{local convergence}(t) = \Sigma_{\textrm{dom}}(t)$$
  * "volume contraction" is the determinant of $\mathbf{J}(t)$:
  $$\textrm{volume contraction}(t) = \left|\mathbf{J}(t)\right|$$
  * "total variance" is the trace of $\mathbf{J}(t) \mathbf{J}(t)^T$:
  $$\textrm{total variance}(t) = \textrm{Tr}\left(\mathbf{J}(t) \mathbf{J}(t)^T\right)$$

## Discrete-time vs. continuous-time Jacobians

We note that the interaction matrix estimated in \@ref(eq:system-matrix-model), besides being time-varying, is not strictly equivalent to the interaction matrix that is usually described in the literature on stability [@May_1973a; @Pimm_1984; @Novak_2016]. Here, time series are used to estimate $\mathbf{J}$, which can be interpreted as the Jacobian of the discrete-time map $G$, $\mathbf{n}(t+1) = G(\mathbf{n}(t))$. In contrast, the interaction matrix of e.g. @Novak_2016, $\mathbf{A}$, is the Jacobian of the continuous-time function $F$, $\dot{\mathbf{n}}(t) = F(\mathbf{n}(t))$. Consequently, properties of the dynamic systems represented by $F$ and $G$, will be computed in different ways, and have different critical thresholds.

For example, as reported in [@Ushio_2018], stability occurs when the magnitude of the dominant eigenvalue is less than $1$, $\left|\lambda_{\textrm{dom}}(t)\right| < 1$, whereas in the continuous-time case, stability requires that the real part of all eigenvalues be less than $0$. Similarly, we define volume contraction as the determininant of the discrete-time Jacobian, $\left|\mathbf{J}\right|$, or equivalently, the product of its eigenvalues. This is in contrast to [@Strogatz_1994], where volume contraction is computed as the trace of the (continuous-time) Jacobian, $\mathrm{Tr} (\mathbf{A})$. Observe that since $\mathbf{J} \approx \exp{\mathbf{A}}$, the eigenvalues of $\mathbf{J}$ and $\mathbf{A}$ are similarly related, thus providing the link between the continuous-time and discrete-time formulations.

## Surrogate method for convergent cross mapping{#ccm-surrogates}

[@Ushio_2018] use a phase-lock twin surrogate method to account for seasonal patterns as a potential confounder when identifying significant causal interactions. Although the Portal rodent abundances also exhibit seasonal patterns, sampling occurs on the new moon, meaning data points represent different times of year and do not fall into convenient equivalence classes for the phase-lock method, such as the 1st of every month.

Thus, we generate surrogate time series by computing the average annual pattern (using the day of year for each observation), and then shuffling the residuals (i.e. the null model is a fixed seasonal pattern, with resampled deviations estimated from the actual time series). 

# Results



# Discussion



# Conclusions

# References